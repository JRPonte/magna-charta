/*! github.com/alphagov/magna-charta magna-charta 17-12-2012 */
(function(t){"use strict";var a=function(){this.init=function(a,s){var i={outOf:65,applyOnInit:!0,toggleText:"Toggle between chart and table",autoOutdent:!1,outdentAll:!1};this.options=t.extend({},i,s);var e=function(){var t,a=3,s=document.createElement("div"),i=s.getElementsByTagName("i");do s.innerHTML="<!--[if gt IE "+ ++a+"]><i></i><![endif]-->";while(10>a&&i[0]);return a>4?a:t}();return this.ENABLED=!(e&&8>e),this.$table=a,this.$graph=t("<div/>").attr("aria-hidden","true"),this.$graph.attr("class",this.$table.attr("class")).addClass("mc-chart"),this.options.stacked=this.$table.hasClass("mc-stacked"),this.options.negative=this.$table.hasClass("mc-negative"),this.options.multiple=!this.options.stacked&&(this.$table.hasClass("mc-multiple")||this.$table.find("tbody tr").first().find("td").length>2),this.options.autoOutdent=this.options.autoOutdent||this.$table.hasClass("mc-auto-outdent"),this.options.outdentAll=this.options.outdentAll||this.$table.hasClass("mc-outdented"),this.options.multiple&&this.$graph.addClass("mc-multiple"),this.options.hasCaption=!!this.$table.find("caption").length,this.ENABLED&&(this.apply(),this.options.applyOnInit||this.toggle()),this}};a.prototype.construct={},a.prototype.construct.thead=function(){var a=t("<div />",{"class":"mc-thead"}),s=t("<div />",{"class":"mc-tr"}),i="";return this.$table.find("th").each(function(a,s){i+='<div class="mc-th">',i+=t(s).html(),i+="</div>"}),s.append(i),a.append(s),a},a.prototype.construct.tbody=function(){var a=t("<div />",{"class":"mc-tbody"});return this.$table.find("tbody tr").each(function(s,i){var e=t("<div />",{"class":"mc-tr"}),n="";t(i).find("td").each(function(a,s){n+='<div class="mc-td">',n+=t(s).html(),n+="</div>"}),e.append(n),a.append(e)}),a},a.prototype.construct.caption=function(){var t=this.$table.find("caption");return t.clone()},a.prototype.construct.toggleLink=function(){var a=this;return t("<a />",{href:"#","class":"mc-toggle-link",text:this.options.toggleText}).on("click",function(t){a.toggle(t)})},a.prototype.constructChart=function(){var t=this.construct.thead.call(this),a=this.construct.tbody.call(this),s=this.construct.toggleLink.call(this);if(this.options.hasCaption){var i=this.construct.caption.call(this);this.$graph.append(i)}this.$table.before(s),this.$graph.append(t),this.$graph.append(a)},a.prototype.apply=function(){this.ENABLED&&(this.constructChart(),this.addClassesToHeader(),this.calculateMaxWidth(),this.applyWidths(),this.insert(),this.$table.addClass("visually-hidden"),this.applyOutdent())},a.prototype.toggle=function(t){this.$graph.toggle(),this.$table.toggleClass("visually-hidden"),t&&t.preventDefault()},a.prototype.utils={isFloat:function(t){return!isNaN(parseFloat(t))},stripValue:function(t){var a=RegExp("\\,|Â£|%|[a-z]","gi");return t.replace(a,"")},returnMax:function(t){for(var a=0,s=0;t.length>s;s++)t[s]>a&&(a=t[s]);return a},isNegative:function(t){return 0>t}},a.prototype.addClassesToHeader=function(){var a=this.$graph.find(".mc-th").filter(":not(:first)");this.options.stacked&&(a.last().addClass("mc-stacked-header mc-header-total"),a=a.filter(":not(:last)")),a.addClass("mc-key-header").filter(":not(.mc-stacked-header)").each(function(a,s){t(s).addClass("mc-key-"+(a+1))})},a.prototype.calculateMaxWidth=function(){var a=this,s=[],i=0;this.$graph.find(".mc-tr").each(function(e,n){var o=t(n),l=o.find(".mc-td:not(:first)");a.options.stacked&&(l.last().addClass("mc-stacked-total"),l=l.filter(":not(:last)")),o.find(".mc-td:first").addClass("mc-key-cell");var r=0;l.each(function(e,n){var o=t(n).addClass("mc-bar-cell").addClass("mc-bar-"+(e+1)),l=a.utils.stripValue(o.text());if(a.utils.isFloat(l)){var c=parseFloat(l,10),d=Math.abs(c);0===c&&o.addClass("mc-bar-zero"),a.options.negative&&(a.utils.isNegative(c)?(o.addClass("mc-bar-negative"),d>i&&(i=d)):o.addClass("mc-bar-positive")),c=d,a.options.stacked?r+=c:(r=c,s.push(c))}}),a.options.stacked&&s.push(r)});var e={};return e.max=parseFloat(a.utils.returnMax(s),10),e.single=parseFloat(this.options.outOf/e.max,10),this.options.negative&&(e.marginLeft=parseFloat(i,10)*e.single,e.maxNegative=parseFloat(i,10)),e},a.prototype.applyWidths=function(){this.dimensions=this.calculateMaxWidth();var a=this;this.$graph.find(".mc-tr").each(function(s,i){var e=t(i);e.find(".mc-bar-cell:not(.mc-bar-zero)").length,e.find(".mc-bar-cell").each(function(s,i){var e=t(i),n=parseFloat(a.utils.stripValue(e.text()),10),o=n*a.dimensions.single,l=Math.abs(n),r=Math.abs(o);if(a.options.negative)if(e.hasClass("mc-bar-positive"))e.css("margin-left",a.dimensions.marginLeft+"%");else if(a.dimensions.maxNegative>l){var c=(a.dimensions.maxNegative-l)*a.dimensions.single;e.css("margin-left",c+"%")}e.wrapInner("<span />"),e.css("width",r+"%")})})},a.prototype.insert=function(){this.$table.after(this.$graph)},a.prototype.applyOutdent=function(){var a=this;this.$graph.find(".mc-bar-cell"),this.$graph.find(".mc-bar-cell").each(function(s,i){var e=t(i),n=parseFloat(a.utils.stripValue(e.text()),10),o=e.children("span"),l=o.width()+10,r=e.width();parseFloat(e[0].style.width,10),e.height(),a.options.stacked?l>r&&n>0&&e.addClass("mc-value-overflow"):(0===n&&e.addClass("mc-bar-outdented"),a.options.autoOutdent&&l>r||a.options.outdentAll?(e.addClass("mc-bar-outdented"),o.css({"margin-left":"100%",display:"inline-block"})):e.addClass("mc-bar-indented"))})},t.magnaCharta=function(t,s){return(new a).init(t,s)}})(jQuery);